---
- hosts: localhost
  connection: local
  become: yes
  
  tasks:
    - name: "Ensure group mandj exists"
      group:
        name: mandj
        gid: 1002
        state: present
        
    - name: Change password of user 'ubuntu'
      user:
        name: ubuntu
        password: '$6$ZbWanugns2E$6FeGCSWq97yivD1OZEMPPPWqEzhn.5GbvU4HEe.ohb7lXp3Dz5PcFWggdFh9.d/uvWr9Fbp4XiET2vahDALDY.'

    - name: Create a user account for Mike
      user:
        name: mike
        uid: 1969
        group: mandj
        password: '$6$ZbWanugns2E$6FeGCSWq97yivD1OZEMPPPWqEzhn.5GbvU4HEe.ohb7lXp3Dz5PcFWggdFh9.d/uvWr9Fbp4XiET2vahDALDY.'
        groups: adm, dialout, cdrom, floppy, sudo, audio, dip, video, plugdev, netdev, lxd, lpadmin, sambashare
        append: yes
        state: present
        shell: /bin/bash
        system: no
        create_home: yes

    - name: Set Mike's authorized_key for X200
      authorized_key:
        user: mike
        state: present
        key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIELda1s1OlsuYJK3lrYVLX6fQytK4H9/lNXBlRIrM+aYR0xvMfzYtr2k0JFAaX53PUMuPgIO/qqYK3DjwUtqfeBlYuqVsCvUUxLMfUM4u1sxYHxmI/PVSh02SrwvV4cibCr0ni1SW22j4+k7K34jm1CQeI5e5+ZlcbYL4jThNK8JXwLhOB3/VBdicj+Z66uWAtcPZ67Z7w0wpEnuO5jfTphRoBzL+DeJhYmdipfFOlqaRuzQ/raNwyBqDSy92k01w+vzDnQOSq1nsXE8femzBEmV2Y0M5XxAn50Hbtt5A6oaaLO8xObkaQrmQpEfUsC63jU1z6e7iN7lLQcdp9DCN mike@X200'
      
    - name: Set Mike's authorized_key for PineBookPro
      authorized_key:
        user: mike
        state: present  
        key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC1Qsji4M/UXHerft05HMTfxl1F0GBLaetaaqHvrQkmb2jaZMpIfh0WCYEf2PwZC0kY/2Ex1PQ8R9ZLZHEqkOmJ1ZXcmbwTo0k6Zx4wrNGl7KPWfLPCDTi/zT25ZEe+gZqZgpvF8gdUpyiXEf60mz8uvC54IRjpILEgXxfugpN9qcmW0C3lFcUTFKfXV3ZCjwZ6urL3qdWfyIjKzZ667M1gsyvzxllmBchrPBcnWySGP0SZ8O049Sqa50QoLAaPLeX15w6ELCTVVJEQeQ8mFw0HfPL91ceg3vy1IJuBFOzSA8ZtUM5nZgv+axY3Hx9yU/oTRGJmTQKKVXaqlZqlCKTV rock@Debian-Desktop'
    
    - name: "Change SSH port number"
      lineinfile:
        dest: "/etc/ssh/sshd_config"
        regexp: "^Port"
        line: "Port 7056"
      notify: Restart ssh
      
    - name: Disallow password authentication
      lineinfile:
        dest: "/etc/ssh/sshd_config"
        regexp: "^PasswordAuthentication"
        line: "PasswordAuthentication no"
        state: present
      notify: Restart ssh

    - name: Disallow root SSH access
      lineinfile:
        dest: "/etc/ssh/sshd_config"
        regexp: "^PermitRootLogin"
        line: "PermitRootLogin no"
        state: present
      notify: Restart ssh
  
    - name: Set timezone
      timezone:
        name: Europe/London
        
    - name: Set GB locale
      locale_gen:
        name: en_GB.UTF-8
        state: present


  handlers:
    - name: Restart ssh
      service:
        name: ssh
        state: restarted
